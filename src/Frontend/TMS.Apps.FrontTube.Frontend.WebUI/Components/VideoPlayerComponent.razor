@if (ViewModel == null)
{
    <MudAlert Severity="Severity.Warning">No video player ViewModel provided.</MudAlert>
}
else if (ViewModel.LoadState == VideoLoadState.Loading)
{
    <MudPaper Class="pa-8" Elevation="0">
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Color="Color.Default">Loading video...</MudText>
        </MudStack>
    </MudPaper>
}
else if (ViewModel.LoadState == VideoLoadState.Error)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        @(ViewModel.ErrorMessage ?? "Failed to load video. Please try again.")
    </MudAlert>
}
else if (ViewModel.LoadState == VideoLoadState.Loaded)
{
    <MudPaper Class="pa-4" Elevation="1">
        @* Player Controls *@
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3" Wrap="Wrap.Wrap">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.subtitle1">Player Mode:</MudText>
                <MudToggleGroup T="PlayerMode" 
                                Value="ViewModel.Streams.PlayerMode"
                                ValueChanged="OnPlayerModeChangedAsync"
                                Color="Color.Primary"
                                Size="Size.Small">
                    <MudToggleItem Value="PlayerMode.Native" Text="Native (â‰¤720p)" />
                    <MudToggleItem Value="PlayerMode.Dash" Text="DASH (HD+)" />
                    <MudToggleItem Value="PlayerMode.Embedded" Text="Embedded" />
                </MudToggleGroup>
            </MudStack>

            @if (ViewModel.Streams.PlayerMode == PlayerMode.Native && ViewModel.Streams.AvailableQualities.Count > 0)
            {
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudText Typo="Typo.subtitle1">Quality:</MudText>
                    <MudSelect T="string" 
                               Value="ViewModel.Streams.SelectedQuality"
                               ValueChanged="OnQualityChanged"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Style="width: 120px;">
                        @foreach (var quality in ViewModel.Streams.AvailableQualities)
                        {
                            <MudSelectItem Value="@quality">@quality</MudSelectItem>
                        }
                    </MudSelect>
                </MudStack>
            }
            else if (ViewModel.Streams.PlayerMode == PlayerMode.Dash && ViewModel.Streams.AvailableDashQualities.Count > 0)
            {
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudText Typo="Typo.subtitle1">Max Quality:</MudText>
                    <MudSelect T="string" 
                               Value="_selectedDashQuality"
                               ValueChanged="OnDashQualityChangedAsync"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Style="width: 120px;">
                        <MudSelectItem Value="@("auto")">Auto (ABR)</MudSelectItem>
                        @foreach (var quality in ViewModel.Streams.AvailableDashQualities)
                        {
                            <MudSelectItem Value="@quality">@quality</MudSelectItem>
                        }
                    </MudSelect>
                    @if (!string.IsNullOrEmpty(_currentDashQuality))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@_currentDashQuality</MudChip>
                    }
                </MudStack>
            }
        </MudStack>

        @* DASH mode info banner *@
        @if (ViewModel.Streams.PlayerMode == PlayerMode.Dash)
        {
            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2" Icon="@Icons.Material.Filled.HighQuality">
                DASH mode supports 1080p, 1440p, and 4K quality with separate audio/video streams via Shaka Player.
                @if (_shakaPlayerLoading)
                {
                    <MudProgressLinear Indeterminate="true" Size="Size.Small" Class="mt-1" />
                }
            </MudAlert>
        }

        @* Video Player *@
        <MudPaper Class="mb-4" Elevation="0" Style="background-color: black;">
            @if (ViewModel.Streams.PlayerMode == PlayerMode.Native)
            {
                <video controls 
                       style="width: 100%; aspect-ratio: 16/9; max-height: 70vh;"
                       poster="@GetPosterUrl()">
                    @if (!string.IsNullOrEmpty(ViewModel.Streams.CurrentStreamUrl))
                    {
                        <source src="@ViewModel.Streams.CurrentStreamUrl" type="video/mp4" />
                    }
                    Your browser does not support the video tag.
                </video>
                @if (string.IsNullOrEmpty(ViewModel.Streams.CurrentStreamUrl))
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-2">
                        No stream URL available for native playback. Try switching to DASH or Embedded mode.
                    </MudAlert>
                }
            }
            else if (ViewModel.Streams.PlayerMode == PlayerMode.Dash)
            {
                <video id="@ShakaVideoElementId"
                       controls 
                       style="width: 100%; aspect-ratio: 16/9; max-height: 70vh;"
                       poster="@GetPosterUrl()">
                </video>
                @if (!string.IsNullOrEmpty(_shakaPlayerError))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-2">
                        DASH playback error: @_shakaPlayerError
                        <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="RetryDashPlayerAsync">Retry</MudButton>
                    </MudAlert>
                }
                @if (string.IsNullOrEmpty(ViewModel.Streams.DashManifestUrl))
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-2">
                        No DASH manifest URL available. Try switching to Embedded mode.
                    </MudAlert>
                }
            }
            else
            {
                @if (!string.IsNullOrEmpty(ViewModel.Streams.EmbedUrl))
                {
                    <iframe src="@ViewModel.Streams.EmbedUrl"
                            style="width: 100%; min-height: 480px; border: none;"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                    </iframe>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning">
                        No embed URL available.
                    </MudAlert>
                }
            }
        </MudPaper>

        @* Video Info *@
        <MudText Typo="Typo.h5" Class="mb-2">@ViewModel.Title</MudText>
        
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Size="Size.Medium" Color="Color.Primary">
                    @(ViewModel.ChannelName?.FirstOrDefault().ToString().ToUpperInvariant() ?? "?")
                </MudAvatar>
                <MudLink OnClick="@OnChannelLinkClicked"
                         Typo="Typo.subtitle1"
                         Style="cursor: pointer;">
                    @ViewModel.ChannelName
                </MudLink>
            </MudStack>

            <MudStack Row="true" Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" />
                    <MudText Typo="Typo.body2">@FormatViewCount(ViewModel.ViewCount) views</MudText>
                </MudStack>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Size="Size.Small" />
                    <MudText Typo="Typo.body2">@FormatViewCount(ViewModel.LikesCount)</MudText>
                </MudStack>
            </MudStack>
        </MudStack>

        @* Description *@
        @if (!string.IsNullOrEmpty(ViewModel.Description))
        {
            <MudExpansionPanels>
                <MudExpansionPanel Text="Description">
                    <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
                        @ViewModel.Description
                    </MudText>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
    </MudPaper>
}
else
{
    <MudPaper Class="pa-8" Elevation="0">
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center">
            <MudIcon Icon="@Icons.Material.Filled.VideoLibrary" Size="Size.Large" Color="Color.Default" />
            <MudText Typo="Typo.h6" Color="Color.Default">Enter a video ID to get started</MudText>
        </MudStack>
    </MudPaper>
}
